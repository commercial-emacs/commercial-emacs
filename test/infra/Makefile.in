### test/infra/Makefile.  Generated from Makefile.in by configure.

# Copyright (C) 2021 Free Software Foundation, Inc.

# This file is part of GNU Emacs.

# GNU Emacs is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# GNU Emacs is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.

### Commentary:

## Generate the test-jobs.yml file for emba.

### Code:

SHELL = @SHELL@

top_builddir = @top_builddir@

-include ${top_builddir}/src/verbose.mk

## Get the tests for only a specific directory.
SUBDIRS ?= $(shell make -s -C .. subdirs)
SUBDIR_TARGETS =
FILE = test-jobs.yml

define subdir_template
  $(eval target = check-$(subst /,-,$(1)))
  SUBDIR_TARGETS += $(target)

  $(eval
    ifeq ($(findstring src, $(1)), src)
    define changes
	@echo "        - $(1)/*.{h,c}" >>$(FILE)
	@echo "        - test/$(1)/*.el" >>$(FILE)
    endef
    else ifeq ($(findstring misc, $(1)), misc)
    define changes
	@echo "        - admin/*.el" >>$(FILE)
	@echo "        - test/$(1)/*.el" >>$(FILE)
    endef
    else
    define changes
	@echo "        - $(1)/*.el" >>$(FILE)
	@echo "        - test/$(1)/*.el" >>$(FILE)
    endef
    endif)

  .PHONY: $(target)

  $(target):
	@echo "test-$(subst /,-,$(1))-inotify:" >>$(FILE)
	@echo "  stage: normal" >>$(FILE)
	@echo "  extends: [.job-template, .test-template]" >>$(FILE)
	@echo "  rules:" >>$(FILE)
	@echo "    - changes:" >>$(FILE)
	$(changes)
	@echo "  variables:" >>$(FILE)
	@echo "    target: emacs-inotify" >>$(FILE)
	@echo "    make_params: \"-C test $(target)\"" >>$(FILE)
	@echo >>$(FILE)
endef

$(foreach subdir, $(SUBDIRS), $(eval $(call subdir_template,$(subdir))))

all: generate-test-jobs

.PHONY: generate-test-jobs $(FILE)

generate-test-jobs: clean $(FILE) $(SUBDIR_TARGETS)

$(FILE):
	$(AM_V_GEN)

clean:
	@rm -f $(FILE)
